---
title: "Rent Analysis"
output:
  html_document:
    toc: true
    df_print: paged
  html_notebook:
    toc: true
    fig_width: 3
    fig_height: 3
    fig_caption: true
  pdf_document:
    toc: true
  word_document:
    toc: true
editor_options:
  chunk_output_type: inline
---
```{r setup, include=FALSE}
dir.create("figuresBN", showWarnings = FALSE)  
knitr::opts_chunk$set(fig.path = "figuresBN/")
```
--------------------------------------------------------------------------------
# Main code from here
```{r}
library(LinRegInteractive)
data(munichrent03)
data <- munichrent03

#install.packages("openxlsx")
library(openxlsx)
write.xlsx(data, file = "munichrent03.xlsx")
```


# Load the dataset
```{r}
str(data)
names(data)
```

```{r}
summary(data)
```

rentsqm = rent * area
```{r}
round(data$rent[2]/data$area[2],2)
data$rentsqm[2]
round(data$rent[100]/data$area[100],2)
data$rentsqm[100]
```

```{r}
data$rentsqm <- NULL
```

```{r}
head(sort(table(data$district), decreasing = TRUE), 7)
```

```{r}
head(sort(table(data$district[data$location %in% c("top", "good")]), 
          decreasing = TRUE),7)
```

```{r}
library(dplyr)
cols <- c("bathextra", "bathtile", "cheating", "upkitchen", "wwater")
total_n <- nrow(data)
feature_yes_count <- sapply(cols, function(col) {
  sum(data[[col]] == "yes", na.rm = TRUE)
}) |> unname()
feature_summary <- data.frame(
  Feature = cols,
  Count = as.integer(feature_yes_count),
  Percent = round(100 * feature_yes_count / total_n, 1)
)
print(feature_summary)
```


```{r}
library(DataExplorer)
plot_histogram(data)
```
```{r}
table(data$room)
table(data$yearc)
```

```{r}
names(data[-c(1,2,3,4,8,9)])
```
 
```{r echo=TRUE, warning=FALSE}
library(gRbase)
library(Rgraphviz)
library(bnlearn)
library(gRain)
library(ggm)
library(igraph)
```

```{r}
data$rooms <- as.factor(data$rooms)
data$location <- as.factor(as.character(data$location))
```

```{r}
data$yearc <- round(data$yearc)
data$year_group <- cut(data$yearc,
  breaks = c(1917, 1959, 1969, 1989, 2001),
  labels = c("1918-1959", "1960-1969", "1970-1989", "1990-2001"),right = TRUE)
length(data$year_group) == nrow(data)
table(data$year_group)
```

```{r}
district_counts <- sort(table(data$district), decreasing = TRUE)
district_counts
district_ordered <- names(district_counts)
```

```{r}
area1_index <- c(1, 2, 3, 4, 5, 6, 9 ,11, 12, 16, 21)
district_ordered[area1_index]
```

```{r}
area2_index <- c(7, 8, 10, 13, 14, 15, 17, 20, 22)
district_ordered[area2_index]
```

```{r}
area3_index <- setdiff(1:length(district_ordered), c(area1_index, area2_index))
district_ordered[area3_index]
```

```{r}
district_group_info <- data.frame(district = district_ordered,
                                  group = NA)
district_group_info$group[area1_index] <- "Area1"
district_group_info$group[area2_index] <- "Area2"
district_group_info$group[area3_index] <- "Area3"
data$district_group <- 
  district_group_info$group[match(data$district, district_group_info$district)]
data$district_group <- as.factor(data$district_group)
sum(table(data$district_group)) == nrow(data)
```
```{r}
table(data$district_group)
```

```{r}
data_bn <- data[, !(names(data) %in% c("yearc", "district"))]
data_bn$rent <- as.numeric(data_bn$rent)
data_bn$area <- as.numeric(data_bn$area)
```

```{r}
data_disc <- discretize(data_bn, method = "hartemink",breaks = 3,ibreaks = 60,
                        idisc = "quantile")
```
```{r}
table(data_disc$rent)
table(data_disc$area)
```
```{r}
str(data_disc)
```

```{r}
# boot.strength(data = , R = 300, 
#               algorithm = c("pc.stable","hc","mmhc"),
#               algorithm.args = list())
```

```{r warning=FALSE}
set.seed(42)
boot_pc <- boot.strength(data = data_disc, R = 500, algorithm = "pc.stable",
                         algorithm.args = list(test = "mi"))
boot_hc <- boot.strength(data = data_disc, R = 500, algorithm = "hc", 
                         algorithm.args = list(score = "bic"))
boot_mmhc <- boot.strength(data = data_disc, R = 500, algorithm = "mmhc")
```

```{r}
avgnet_pc <- averaged.network(boot_pc[boot_pc$direction>=0.5,], 
                              threshold = 0.85)
avgnet_hc <- averaged.network(boot_hc[boot_hc$direction>=0.5,], 
                              threshold = 0.85)
avgnet_mmhc <- averaged.network(boot_mmhc[boot_mmhc$direction>=0.5,], 
                                threshold = 0.55)
```

```{r}
mean_strength <- function(strength, DAG) 
  {arcs_net <- arcs(DAG)
  matched_strength <- strength[
    apply(strength[, c("from", "to")], 1, function(x)
      any(apply(arcs_net, 1, function(y) all(x == y)))
    ),]
  mean(matched_strength$strength)
  }
results <- data.frame(
  Algorithm = c("pc.stable", "hc", "mmhc"),
  BIC = c(score(avgnet_pc,   data = data_disc, type = "bic"),
          score(avgnet_hc,   data = data_disc, type = "bic"),
          score(avgnet_mmhc, data = data_disc, type = "bic")),  
  Egdes=c(dim(arcs(avgnet_pc))[1],
          dim(arcs(avgnet_hc))[1],
          dim(arcs(avgnet_mmhc))[1]),
  Mean_Strength = c(mean_strength(boot_pc,   avgnet_pc),
                    mean_strength(boot_hc,   avgnet_hc),
                    mean_strength(boot_mmhc, avgnet_mmhc))
  )
results
```

```{r}
graphviz.plot(avgnet_pc, main = "Averaged Model - pc.stable")
graphviz.plot(avgnet_hc, main = "Averaged Model - hc")
graphviz.plot(avgnet_mmhc, main = "Averaged Model - mmhc")
```

```{r}
avgnet_pc <- averaged.network(boot_pc[boot_pc$direction>=0.5,], 
                              threshold = 0.75)
avgnet_hc <- averaged.network(boot_hc[boot_hc$direction>=0.5,], 
                              threshold = 0.75)
avgnet_mmhc <- averaged.network(boot_mmhc[boot_mmhc$direction>=0.5,], 
                                threshold = 0.75)
```

```{r}
graphviz.plot(avgnet_pc, main = "Averaged Model - pc.stable")
graphviz.plot(avgnet_hc, main = "Averaged Model - hc")
graphviz.plot(avgnet_mmhc, main = "Averaged Model - mmhc")
```

```{r}
results <- data.frame(
  Algorithm = c("pc.stable", "hc", "mmhc"),
  BIC = c(score(avgnet_pc,   data = data_disc, type = "bic"),
          score(avgnet_hc,   data = data_disc, type = "bic"),
          score(avgnet_mmhc, data = data_disc, type = "bic")),  
  Egdes=c(dim(arcs(avgnet_pc))[1],
          dim(arcs(avgnet_hc))[1],
          dim(arcs(avgnet_mmhc))[1]),
  Mean_Strength = c(mean_strength(boot_pc,   avgnet_pc),
                    mean_strength(boot_hc,   avgnet_hc),
                    mean_strength(boot_mmhc, avgnet_mmhc))
  )
results
```
hc (75%)
```{r}
graphviz.plot(avgnet_hc, main = "Final Model")
```

```{r}
final_mod_dag=averaged.network(boot_hc[boot_hc$direction>=0.5,],threshold = 0.75)
```

```{r echo=TRUE, message=TRUE, warning=TRUE}
fit = bn.fit(final_mod_dag, data = data_disc, method = "mle")
```

```{r}
has_na <- sapply(fit, function(node) any(is.na(unlist(node$prob))))
names(has_na)[has_na]
```

```{r}
fit$rooms
fit$location
```
```{r}
dsep(fit,x="rooms",y="rent",z="area")
```
```{r}
cpquery(fit,event = (bathextra=="yes"),evidence = (district_group == "Area1"),n=10^6)
```
